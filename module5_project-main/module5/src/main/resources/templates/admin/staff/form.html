<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">

<head>
    <meta charset="UTF-8">
    <title th:text="${staff.id == null ? 'Thêm nhân viên mới' : 'Chỉnh sửa nhân viên'}">Thêm nhân viên</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<style>
    .form-label-required::after {
    content: " *";
    color: #ff3366 !important;
    font-weight: 900;
    text-shadow: 0 0 8px rgba(255, 51, 102, 0.5);
}

/* Input focus đẹp hơn */
.form-control:focus {
    background-color: #351C50 !important;
    border-color: var(--color-accent) !important;
    box-shadow: 0 0 0 3px rgba(169, 38, 247, 0.3) !important;
    color: white !important;
}

/* DẤU TÍCH XANH & X ĐỎ SIÊU SANG TRỌNG */
.form-control.is-valid {
    border-color: #28a745 !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.8875rem) center;
    background-size: calc(0.75em + 0.875rem) calc(0.75em + 0.875rem);
}

.form-control.is-invalid {
    border-color: #dc3545 !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.8875rem) center;
    background-size: calc(0.75em + 0.875rem) calc(0.75em + 0.875rem);
}

/* Hiệu ứng mượt khi hiện tích xanh */
.form-control {
    transition: all 0.3s ease !important;
}
</style>
<body>

    <!-- SIDEBAR & NAVBAR – ĐỒNG BỘ HOÀN TOÀN VỚI TRANG LIST -->
    <div th:replace="~{admin/layout :: layout(
        content = ~{this :: content},
        pageTitle = ${staff.id == null ? 'Thêm nhân viên mới' : 'Chỉnh sửa nhân viên'},
        activeMenu = 'staffs'
    )}">

        <div th:fragment="content">
            

<!-- CARD FORM – SIÊU PHẨM DARK MODE 2025 – HOÀN HẢO TUYỆT ĐỐI -->
<div class="card shadow-lg border-0" style="background-color: var(--color-sidebar); border-radius: 16px;">
    <div class="card-body p-5">

        <form th:action="@{/admin/staffs/save}" th:object="${staff}" method="post" enctype="multipart/form-data"
            class="needs-validation" novalidate>

            <input type="hidden" th:field="*{id}" />

            <!-- AVATAR + UPLOAD -->
            <div class="text-center mb-5">
                <div class="position-relative d-inline-block">
                    <img th:src="${staff.avatarUrl} ?: 'https://i.imgur.com/tyEzny9.png'" id="avatarPreview"
                        class="rounded-circle shadow-lg" style="width:160px;height:160px;object-fit:cover;border:6px solid var(--color-accent);
                                box-shadow:0 0 0 6px rgba(169,38,247,0.3),0 10px 30px rgba(0,0,0,0.4);"
                        alt="Avatar nhân viên">
                    <div class="position-absolute top-0 start-0 w-100 h-100 rounded-circle" style="border:3px solid transparent;background:linear-gradient(45deg,transparent,rgba(169,38,247,0.3),transparent) border-box;
                                pointer-events:none;opacity:0;transition:opacity .3s;" id="avatarGlow"></div>
                </div>
                <div class="mt-4">
                    <label class="btn btn-outline-accent px-5 py-3 rounded-pill fw-bold shadow-sm"
                        style="border:2px solid var(--color-accent);color:var(--color-light-text);font-size:1.1rem;">
                        <i class="fas fa-camera fa-lg me-2"></i>
                        <span th:text="${staff.id == null} ? 'Chọn ảnh đại diện' : 'Đổi ảnh đại diện'"></span>
                        <input type="file" name="avatarFile" accept="image/*" class="d-none"
                            onchange="previewImage(event)">
                    </label>
                    <p class="mt-3 mb-0 fw-semibold" style="font-size:1.15rem;color:#a0d8ff!important;">
                        <i class="fas fa-image me-2"></i>JPG, PNG, GIF • Tối đa 10MB
                    </p>
                </div>
            </div>

            <div class="row g-4">
                <!-- CỘT TRÁI -->
                <div class="col-lg-6">

                    <!-- TÀI KHOẢN -->
                    <div class="mb-4">
                        <label class="form-label text-light fw-semibold form-label-required">Tài khoản</label>
                        <input type="text" class="form-control form-control-lg bg-active border-0 text-light"
                            th:field="*{username}" placeholder="Nhập tài khoản" required
                            th:readonly="${staff.id != null}">
                        <div class="alert alert-warning border-0 py-2 px-3 mt-2 rounded-3" th:if="${staff.id != null}"
                            style="background:rgba(255,51,102,0.15);border-left:4px solid #ff3366;">
                            <small class="fw-semibold" style="color:#ff3366;">
                                <i class="fas fa-lock me-2"></i>
                                Tài khoản không thể thay đổi sau khi tạo
                            </small>
                        </div>
                    </div>

                    <!-- MẬT KHẨU KHI THÊM MỚI -->
                    <div th:if="${staff.id == null}">
                        <div class="mb-4">
                            <label class="form-label text-light fw-semibold form-label-required">Mật khẩu</label>
                            <input type="password" class="form-control form-control-lg bg-active border-0 text-light"
                                name="password" placeholder="Nhập mật khẩu" required minlength="6">
                            <div class="invalid-feedback">Mật khẩu phải ít nhất 6 ký tự</div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-light fw-semibold form-label-required">Nhập lại mật
                                khẩu</label>
                            <input type="password" class="form-control form-control-lg bg-active border-0 text-light"
                                name="confirmPassword" placeholder="Nhập lại mật khẩu" required>
                            <div class="invalid-feedback">Mật khẩu không khớp</div>
                        </div>
                    </div>

                    <!-- ĐỔI MẬT KHẨU KHI EDIT -->
                    <div th:if="${staff.id != null}" class="mt-5 p-4 rounded-4"
                        style="background:rgba(169,38,247,0.08);border:2px dashed var(--color-accent);">
                        <h6 class="mb-4 d-flex align-items-center"
                            style="color:#e0e7ff;font-weight:700;letter-spacing:0.5px;">
                            <i class="fas fa-key me-3" style="color:#a0d8ff;font-size:1.4rem;"></i>
                            ĐỔI MẬT KHẨU <span class="ms-2 fw-normal text-info opacity-80">(tùy chọn)</span>
                        </h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <input type="password"
                                    class="form-control form-control-lg bg-active border-0 text-dark"
                                    name="newPassword" placeholder="Mật khẩu mới (để trống nếu không đổi)">
                            </div>
                            <div class="col-12">
                                <input type="password"
                                    class="form-control form-control-lg bg-active border-0 text-dark"
                                    name="confirmNewPassword" placeholder="Nhập lại mật khẩu mới">
                            </div>
                        </div>
                        <small class="text-info d-block mt-2">
                            <i class="fas fa-info-circle me-1"></i>
                            Để trống nếu bạn không muốn thay đổi mật khẩu
                        </small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-light fw-semibold form-label-required">Họ và tên</label>
                        <input type="text" class="form-control form-control-lg bg-active border-0 text-dark"
                            th:field="*{fullName}" placeholder="Nguyễn Văn A" required>
                        <div class="invalid-feedback">Vui lòng nhập họ tên</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-light fw-semibold form-label-required">Ngày sinh</label>
                        <input type="date" class="form-control form-control-lg bg-active border-0 text-dark"
                            th:field="*{birthDate}" required max="2010-12-31">
                        <div class="invalid-feedback">Vui lòng chọn ngày sinh</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-light fw-semibold form-label-required">Giới tính</label>
                        <div class="d-flex gap-4 mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" th:field="*{gender}" value="Nam" id="male"
                                    required>
                                <label class="form-check-label text-light" for="male">Nam</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" th:field="*{gender}" value="Nữ"
                                    id="female">
                                <label class="form-check-label text-light" for="female">Nữ</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CỘT PHẢI -->
                <div class="col-lg-6">
                    <div class="mb-4">
                        <label class="form-label text-light fw-semibold form-label-required">Email</label>
                        <input type="email" class="form-control form-control-lg bg-active border-0 text-dark"
                            th:field="*{email}" placeholder="email@cinemago.com" required>
                        <div class="invalid-feedback">Email không hợp lệ</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-light fw-semibold form-label-required">CMND/CCCD</label>
                        <input type="text" class="form-control form-control-lg bg-active border-0 text-dark"
                            th:field="*{idCard}" placeholder="0123456789" required pattern="\d{9,12}" maxlength="12">
                        <div class="invalid-feedback">CMND/CCCD phải chứa 9-12 chữ số</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-light fw-semibold form-label-required">Số điện thoại</label>
                        <input type="tel" class="form-control form-control-lg bg-active border-0 text-dark"
                            th:field="*{phone}" placeholder="0901234567" required pattern="0[0-9]{9}">
                        <div class="invalid-feedback">Số điện thoại phải có 10 số, bắt đầu bằng 0</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-light fw-semibold">Địa chỉ</label>
                        <input type="text" class="form-control form-control-lg bg-active border-0 text-dark"
                            th:field="*{address}" placeholder="123 Đường ABC, TP.HCM">
                    </div>
                </div>
            </div>

            <!-- NÚT HÀNH ĐỘNG -->
            <div class="text-center mt-5 pt-4 border-top" style="border-color:var(--color-border)!important;">
                <button type="submit" class="btn btn-primary btn-lg px-5 shadow-lg"
                    style="background:var(--color-accent);border:none;font-weight:700;letter-spacing:0.5px;">
                    <i class="fas fa-save me-2"></i>
                    <span th:text="${staff.id == null} ? 'THÊM NHÂN VIÊN' : 'CẬP NHẬT THÔNG TIN'">LƯU</span>
                </button>
                <a th:href="@{/admin/staffs}" class="btn btn-secondary btn-lg px-5 ms-3">
                    <i class="fas fa-arrow-left me-2"></i>HỦY BỎ
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    // ====================== 1. BOOTSTRAP VALIDATION + FOCUS LỖI + SCROLL MƯỢT ======================
    (() => {
        'use strict'

        const forms = document.querySelectorAll('.needs-validation')

        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()

                    // Tự động focus + scroll mượt đến ô đầu tiên bị lỗi
                    const firstInvalid = form.querySelector(':invalid')
                    if (firstInvalid) {
                        firstInvalid.focus()
                        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' })
                    }
                }
                form.classList.add('was-validated')
            }, false)
        })
    })();

    // ====================== 2. REAL-TIME VALIDATION + DẤU TÍCH XANH SIÊU ĐẸP ======================
    document.addEventListener('DOMContentLoaded', () => {
        const inputs = document.querySelectorAll('.form-control, .form-check-input')

        inputs.forEach(input => {
            const validate = () => {
                input.classList.remove('is-valid', 'is-invalid')

                if (input.checkValidity() && (input.value.trim() !== '' || input.hasAttribute('required'))) {
                    input.classList.add('is-valid')
                } else if (input.value.trim() !== '' || input.hasAttribute('required')) {
                    input.classList.add('is-invalid')
                }
            }

            input.addEventListener('input', validate)
            input.addEventListener('blur', validate)

            // Xử lý riêng cho radio (giới tính)
            if (input.type === 'radio') {
                input.addEventListener('change', () => {
                    const name = input.getAttribute('name')
                    const radios = document.querySelectorAll(`input[name="${name}"]`)
                    const checked = Array.from(radios).some(r => r.checked)

                    radios.forEach(r => {
                        r.classList.remove('is-valid', 'is-invalid')
                        if (checked) r.classList.add('is-valid')
                    })
                })
            }
        })
    })

    // ====================== 3. PREVIEW ẢNH AVATAR SIÊU MƯỢT ======================
    function previewImage(event) {
        const file = event.target.files[0]
        if (file) {
            const reader = new FileReader()
            reader.onload = e => {
                const preview = document.getElementById('avatarPreview')
                if (preview) preview.src = e.target.result
            }
            reader.readAsDataURL(file)
        }
    }

    // ====================== BONUS: Hiệu ứng hover avatar phát sáng ======================
    document.addEventListener('DOMContentLoaded', () => {
        const avatar = document.getElementById('avatarPreview')
        const glow = document.getElementById('avatarGlow')
        if (avatar && glow) {
            avatar.addEventListener('mouseenter', () => glow.style.opacity = '1')
            avatar.addEventListener('mouseleave', () => glow.style.opacity = '0')
        }
    })
</script>
        </div>
    </div>

</body>

</html>